# Task 1: Find the total price of each of the first 5 orders,
# ordered by order_id.

SELECT orders.order_id, SUM(products.price*line_items.quantity)
AS total_price
FROM products 
  JOIN line_items ON line_items.product_id = products.product_id
  JOIN orders ON orders.order_id = line_items.order_id
GROUP BY orders.order_id
ORDER BY orders.order_id LIMIT 5;

# Task 2: Understanding Subqueries
SELECT c.customer_name, c.customer_id,
AVG(t.total_price) AS average_order_price
FROM customers AS c
JOIN (SELECT orders.customer_id, orders.order_id,
        SUM(products.price*line_items.quantity) AS total_price
        FROM products JOIN line_items ON line_items.product_id = products.product_id
        JOIN orders ON orders.order_id = line_items.order_id
        GROUP BY orders.order_id) AS t
ON t.customer_id = c.customer_id
GROUP BY c.customer_id, customer_name
ORDER BY c.customer_name;

# Task 3: Creating a New Order
SELECT customers.customer_id FROM customers WHERE customers.customer_name = 'Perez and Sons';
SELECT employees.employee_id FROM employees WHERE employees.first_name = 'Miranda' AND employees.last_name = 'Harris';
SELECT products.product_id FROM products ORDER BY  products.price ASC LIMIT 5;
BEGIN;
INSERT INTO orders (customer_id, employee_id, date) VALUES(16,7, '2025-03-11') RETURNING order_id;
INSERT INTO line_items (order_id, product_id, quantity) VALUES (252, 23, 2), (252, 18, 5), (252, 43, 5), (252, 9, 5), (252, 44, 5);
COMMIT;
SELECT * FROM line_items WHERE order_id = 252;

# Task 4: Aggregation with Having
SELECT employees.first_name, employees.last_name, COUNT(orders.order_id) as order_count 
FROM employees JOIN orders ON orders.employee_id = employees.employee_id 
GROUP BY employees.employee_id, employees.first_name, employees.last_name 
HAVING COUNT(orders.order_id) > 5
ORDER BY employees.last_name;